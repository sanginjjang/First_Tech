<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    header {
        font-weight: bold;
        border: lightgray solid 1px;
        width: 100%;
        height: 15%;
        background-color: aliceblue;
        font-size: 50px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    footer {
        font-weight: bold;
        border: lightgray solid 1px;
        width: 100%;
        height: 10%;
        background-color: Faliceblue;
        font-size: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    a {
        /* 링크 기본 스타일 */
        text-decoration: none;
        color: inherit;
    }

    .login {
        font-size: 20px;
    }

    #home {
        margin: 0px 30px 0px 30px;
    }


    #logo {
        margin-left: 30px;
    }

    section {
        width: 100%;
        height: 70%;
        border: lightgray solid 1px;
        text-align: center;
        padding: 50px 0px 50px 0px;
    }

    /*여기까지 공통*/

    .text{
        font-size: 30px;
    }

    .formStyle {
        width: 40%;
        height: 50px;
        font-size: 20px;
    }

    #userId, #userNickname{
        width: 30%;
        height: 50px;
        font-size: 20px;
    }

    #userIdCheck, #userNicknameCheck{
        width: 10%;
        height: 55px;
        font-size: 15px;
    }

    .formStyle1 {
        width: 19%;
        height: 50px;
        font-size: 20px;
    }

    .formStyle2 {
        width: 13%;
        height: 50px;
        font-size: 20px;
    }

    .ajax {
        color: red;
    }
    .container{
        width: 40%;
        border: 1px solid black;
        margin: 0 auto;
    }
    #container {
        width: 40%;
    }

    .terms-row {
        display: flex;
        align-items: center; /* 체크박스와 텍스트가 수평 정렬 */
        justify-content: space-between; /* 체크박스와 텍스트는 왼쪽에, >는 오른쪽 끝에 배치 */
        margin-bottom: 10px;
    }

    .terms-row span {
        margin-left: 5px; /* 체크박스와 텍스트 사이에 약간의 간격 */
    }

    .arrow {
        margin-left: 10px; /* 화살표 간격 */
    }

    .description {
        margin-bottom: 15px;
    }
    
</style>


<body>
    <h1>개인 회원가입 Page</h1>
    <header>
        <div id="logo"> 로고 </div>
        <div class="login">
            <span><a href="/">홈으로</a></span>
            <span id="home"> <a href=""> 기업 홈</a></span>
        </div>
    </header>
    <section>
       
        <div>
            <p class="text">개인 회원가입</p>
        </div>
        <form id="joinForm">
            <div>
                <p>아이디</p>
                <input type="text" name="userId" id="userId" >
                <input type="button" value="중복확인" onclick="idCheck()" id="userIdCheck">
                <br>
                <span class="ajax" id="idAjax"></span>
                
                <p>닉네임</p>
                <input type="text" name="userNickname" id="userNickname" maxlength="10">
                <input type="button" value="중복확인" onclick="nicknameCheck()" id="userNicknameCheck">
                <br>
                <span class="ajax" id="nicknameAjax"></span>
                
                <p>비밀번호</p>
                <input type="text" name="userPassword" id="userPassword" class="formStyle"> <br> <br>
                <input type="text" name="userPwCheck" id="userPwCheck" class="formStyle" placeholder="비밀번호 확인"> <br>
                <span class="ajax" id="pwAjax"></span>
                
                <p>이메일</p>
                <input type="text" name="userEmail" id="userEmail" class="formStyle" > <br>
                <span class="ajax" id="emailAjax"></span>
                
                <p>이름</p>
                <input type="text" name="userName" id="userName" class="formStyle" > <br>
                <span class="ajax" id="nameAjax"></span>

                <p>주민등록번호</p>
                <input type="text" name="userSsnFirst" id="userSsnFirst" class="formStyle1" maxlength="6">
                -
                <input type="text" name="userSsnLast" id="userSsnLast" class="formStyle1" maxlength="7"> <br>
                <span class="ajax" id="ssnAjax"></span>
                
                <p>휴대전화</p>
                <select name="userPhoneFirst" class="formStyle2" id="userPhoneFirst">
                    <option value="010">010</option>
                    <option value="011">011</option>
                    <option value="012">012</option>
                    <option value="013">013</option>
                    <option value="014">014</option>
                    <option value="015">015</option>
                    <option value="016">016</option>
                    <option value="017">017</option>
                    <option value="018">018</option>
                    <option value="019">019</option>
                </select>
                -
                <input type="text" name="userPhoneMiddle" id="userPhoneMiddle" class="formStyle2"  maxlength="4">
                -
                <input type="text" name="userPhoneLast" id="userPhoneLast" class="formStyle2" maxlength="4">
                <br>
                <span class="ajax" id="phoneAjax"></span>


                <p>주소</p>
                <span>여기에 우편번호 찾는 코드가 들어갑니다.</span>
                <br><br>
                <span class="ajax" id="addrAjax"></span> <br>
               	<p>우편번호</p>
                <input type="text" name="userPostalCode" id="userPostalCode" class="formStyle" maxlength="5"> <br>
                <span class="ajax" id="postalCodeAjax"></span>
                <p>주소</p>
                <input type="text" name="userAddress" id="userAddress" class="formStyle" maxlength="3" placeholder="예시) 부산시"> <br>
                <span class="ajax" id="addressAjax"></span>
                
                <p>약관</p>
                <div class="container">
                    <div class="terms-row">
                        <input type="checkbox" class="terms" id="selectAll" onclick="toggleCheckboxes()"> 
                        <span>전체동의</span><br>
                    </div>
                    <span>마케팅 정보 수신 동의(이메일, SMS/MMS)(선택) 동의를 포함합니다.</span>
                    
                    <div class="terms-row">
                        <input type="checkbox" class="terms" id="terms1"> 
                        <span>(필수) 개인회원 약관에 동의</span> 
                        <span class="arrow">></span>
                    </div>
                    <div class="terms-row">
                        <input type="checkbox" class="terms" id="terms2"> 
                        <span>(필수) 개인정보 수집 및 이용에 동의</span> 
                        <span class="arrow">></span>
                    </div>
                    <div class="terms-row">
                        <input type="checkbox" class="terms" id="terms3"> 
                        <span>(선택) 마케팅 정보 수신 동의 - 이메일</span>
                        <span class="arrow">></span>
                    </div>
                    <div class="terms-row">
                        <input type="checkbox" class="terms" id="terms4"> 
                        <span>(선택) 마케팅 정보 수신 동의 - SMS/MMS</span>
                        <span class="arrow">></span>
                    </div>
                </div>
                
                <span class="ajax" id="agreeAjax"></span>
                
                <p>안내</p>
                <div class="container">
                    <p>퍼스트테크 회원으로 가입하시면 하나의 ID로 퍼스트테크가 제공하는 모든 서비스를 이용하실 수 있습니다.</p>
                </div>
                
            
            </div>
            <br>
            <input type="button" onclick="find()" class="formStyle" value="회원가입 완료">

        </form>
    </section>
    <footer>Footer</footer>
</body>

<script>
    const form = document.querySelector("form");
    let check = false;
    let nickNameCheck = false;
    
    //ID 중복체크
    function idCheck(){
        const userId = document.getElementById("userId").value;
        const idAjax = document.getElementById("idAjax");
        
        const idRegex = /^[a-z0-9]{5,20}$/;
		if(userId == ""){
        	idAjax.innerHTML = "아이디를 입력하세요.";
        }else if (/\s/.test(userId)) {  // 공백이 포함되어 있는지 검사
            idAjax.innerHTML = "아이디에 공백이 포함될 수 없습니다.";
        }else if(!idRegex.test(userId)){
        	idAjax.innerHTML = "아이디는 5~20자의 영문 소문자와 숫자만 가능합니다.";
        }else{
        	const xhr = new XMLHttpRequest();
            xhr.onload = function(){
                if(xhr.status === 200){
                    const response = xhr.responseText;
                    if(response === "exists"){
                        idAjax.innerHTML = "이미 사용 중인 아이디입니다.";
                        check = false;
                    }else if(response === "available"){
                        idAjax.innerHTML = "사용 가능한 아이디입니다!";
                        check = true;
                    }
                }else{
                	 idAjax.innerHTML = "컨트롤러 오류";
                }
            }
            xhr.open("POST", "/hyepin/idCheck");
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send("userId=" + encodeURIComponent(userId));
        }
	};
	
	function nicknameCheck(){
		const userNickname = document.getElementById("userNickname").value;
        const nicknameAjax = document.getElementById("nicknameAjax");
        
        //const nicknameRegex = /^[a-z0-9]{5,20}$/;
		if(userNickname == ""){
			nicknameAjax.innerHTML = "닉네임을 입력하세요.";
        }else if (/\s/.test(userNickname)) {  // 공백이 포함되어 있는지 검사
        	nicknameAjax.innerHTML = "닉네임에 공백이 포함될 수 없습니다.";
        }else{
        	const xhr = new XMLHttpRequest();
            xhr.onload = function(){
                if(xhr.status === 200){
                    const response = xhr.responseText;
                    if(response === "exists"){
                    	nicknameAjax.innerHTML = "이미 사용 중인 닉네임입니다.";
                    	nickNameCheck = false;
                    }else if(response === "available"){
                    	nicknameAjax.innerHTML = "사용 가능한 닉네임입니다!";
                    	nickNameCheck = true;
                    }
                }else{
                	nicknameAjax.innerHTML = "컨트롤러 오류";
                }
            }
            xhr.open("POST", "/hyepin/nicknameCheck");
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send("userNickname=" + encodeURIComponent(userNickname));
        }
	}	

    //ajax 호출
    function find(){
    	
        // ajax 모음
    	const idAjax = document.getElementById("idAjax");
    	const nicknameAjax = document.getElementById("nicknameAjax");
		const pwAjax = document.getElementById("pwAjax");
        const emailAjax = document.getElementById("emailAjax");
        const nameAjax = document.getElementById("nameAjax");
        const ssnAjax = document.getElementById("ssnAjax");
        const phoneAjax = document.getElementById("phoneAjax");
        const addrAjax = document.getElementById("addrAjax");
        const agreeAjax = document.getElementById("agreeAjax");
        const postalCodeAjax = document.getElementById("postalCodeAjax");
        const addressAjax = document.getElementById("addressAjax");

        //시작될 때 ajax 모두 초기화
        idAjax.innerHTML = "";
        nicknameAjax.innerHTML = "";
        pwAjax.innerHTML = "";
        emailAjax.innerHTML = "";
        nameAjax.innerHTML = "";
        ssnAjax.innerHTML = "";
        phoneAjax.innerHTML = "";
        addrAjax.innerHTML = "";
        agreeAjax.innerHTML = "";
        postalCodeAjax.innerHTML = "";
        addressAjax.innerHTML = "";

        //모두 다 됐는지 확인하기
        let isValid = true;
        
		//약관동의 확인
        const terms1 = document.getElementById("terms1");
        const terms2 = document.getElementById("terms2");
        if(!terms1.checked || !terms2.checked){
            agreeAjax.innerHTML = "서비스 이용을 위해 약관에 동의해 주세요. "
			document.getElementById("selectAll").focus();
            isValid = false;
        }
        
        
        //주소 확인
        const addrRegex = /^[가-힣]+$/;
        const address = document.getElementById("userAddress").value;
        if(!address.trim()){
        	addressAjax.innerHTML = "주소를 입력하세요.";
            document.getElementById("userAddress").focus();
            isValid = false;	
        }else if (/\s/.test(address)) {  // 공백이 포함되어 있는지 검사
        	addressAjax.innerHTML = "주소에 공백이 포함될 수 없습니다.";
        	isValid = false;
        }else if (!addrRegex.test(address)) {
        	addressAjax.innerHTML = "한글만 입력하세요.";
        	document.getElementById("userAddress").focus();
            isValid = false;
        }
        
        
        //우편번호 확인
        const postalCodeRegex = /^\d*$/;
        const postalCode = document.getElementById("userPostalCode").value;
        if (!postalCodeRegex.test(postalCode)) {
        	postalCodeAjax.innerHTML = "숫자만 입력 가능합니다.";
        	document.getElementById("userPostalCode").focus();
            isValid = false;
        }else if(!postalCode.trim()){
        	postalCodeAjax.innerHTML = "우편번호를 입력하세요.";
            document.getElementById("userPostalCode").focus();
            isValid = false;	
        }else if (/\s/.test(postalCode)) {  // 공백이 포함되어 있는지 검사
        	postalCodeAjax.innerHTML = "우편번호에 공백이 포함될 수 없습니다.";
        	isValid = false;
        }
        
        
      	//전화번호 확인
        const phoneFirst = document.getElementById("userPhoneFirst").value;
      	const phoneMiddle = document.getElementById("userPhoneMiddle").value;
        const phoneLast = document.getElementById("userPhoneLast").value;
        if (!/^\d{4}$/.test(phoneMiddle) || !/^\d{4}$/.test(phoneLast)) {
            phoneAjax.innerHTML = "전화번호를 정확히 입력하세요.";
            document.getElementById("userPhoneMiddle").focus();
            isValid = false;
        }
        
        //주민등록번호 확인
        const ssnFirst = document.getElementById("userSsnFirst").value;
        const ssnLast = document.getElementById("userSsnLast").value;
        if (!/^\d{6}$/.test(ssnFirst) || !/^\d{7}$/.test(ssnLast)) {
            ssnAjax.innerHTML = "주민등록번호를 정확히 입력하세요.";
            document.getElementById("userSsnFirst").focus();
            isValid = false;
        }
        
        //이름 확인
        const name = document.getElementById("userName").value;
        if(!name.trim()){
            nameAjax.innerHTML = "이름을 입력하세요.";
            document.getElementById("userName").focus();
            isValid = false;
        }else if (/\s/.test(name)) {  // 공백이 포함되어 있는지 검사
        	nameAjax.innerHTML = "이름에 공백이 포함될 수 없습니다.";
        	isValid = false;
        }
        
        //email 확인
        const email = document.getElementById("userEmail").value;
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if(!email.trim() || !emailRegex.test(email)){
            emailAjax.innerHTML = "email을 정확히 입력하세요.";
            document.getElementById("userEmail").focus();
            isValid = false;
        }
        
        
        // 비밀번호 확인
        const userPassword = document.getElementById("userPassword").value;
        const userPwCheck = document.getElementById("userPwCheck").value;
        const pwRegex = /^[a-zA-Z0-9!@#$%^&*()_+]{8,16}$/;
        if(!userPassword.trim() || !userPwCheck.trim()){
            pwAjax.innerHTML = "비밀번호를 입력하세요.";
			document.getElementById("userPassword").focus();
			isValid = false;
        }else if(userPassword != userPwCheck){
            pwAjax.innerHTML = "비밀번호가 일치하지 않습니다. 다시 시도해 보세요.";
			document.getElementById("userPwCheck").focus();
			isValid = false;
        }else if(!userPassword.trim() || !pwRegex.test(userPassword)){
        	pwAjax.innerHTML = "비밀번호는 8~16자 영문 대 소문자, 숫자, 특수문자만 사용가능합니다.";
        	document.getElementById("userPassword").focus();
        	isValid = false;
        }
        
      //닉네임 확인
        if(!nickNameCheck){
        	nicknameAjax.innerHTML = "닉네임 중복 확인 후 가입을 진행해 주세요."
            document.getElementById("userNickname").focus();
            isValid = false;
        }
        
        //id 확인
        if(!check){
            idAjax.innerHTML = "아이디 중복 확인 후 가입을 진행해 주세요."
            document.getElementById("userId").focus();
            isValid = false;
        }
        
        

        // ------------------------------------------------------------
        //여기서부터 AJax
        if(isValid){
        	
      
     		const form = document.getElementById("joinForm");
        	const formData = new FormData(form);
			//const formData = new URLSearchParams(new FormData(form)).toString();
        	
    		// 전화번호 DB 확인
            const fullPhone = `${phoneFirst}-${phoneMiddle}-${phoneLast}`;
            //document.getElementById("userPhone").value = fullPhone;
			console.log(phoneFirst);
			console.log(phoneMiddle);
			console.log(phoneLast);
			console.log(fullPhone);
			formData.append("userPhone", fullPhone);
			
			
            // 이메일 DB 확인

            //주민등록번호 DB확인
            const fullSsn = `${ssnFirst}-${ssnLast}`;
            //document.getElementById("userSsn").value = fullSsn;
            formData.append("userSsn", fullSsn);
            

            const xhr = new XMLHttpRequest();
            xhr.onload = function(){
            	if(xhr.status === 200){
            		const response = xhr.responseText;
            		if(response === "exists"){
            			alert("이미 가입된 정보가 있습니다.");
            			window.location.href = "/hyepin/login";
            		}else if(response === "ready"){
            			alert("회원가입 실패!");
            		}else if(response === "available"){
            			alert("회원가입이 완료되었습니다.");
            			window.location.href = "/hyepin/login";
            		}
            	}else{
            		alert("서버오류 발생");
            	}
            }
            
            xhr.open("POST", "/hyepin/userJoinResult");  
            //xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send(formData);
        	
        }
        
         // document.getElementById("findForm").submit();
    }

    function toggleCheckboxes(){
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.terms');

        checkboxes.forEach(function(checkbox){
            checkbox.checked = selectAll.checked;
        });
    }
    


</script>



</html>